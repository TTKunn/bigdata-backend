# [104] 商品查询接口技术实现文档

## 文档信息

| 文档编号 | [104] |
|----------|-------|
| 文档名称 | 商品查询接口技术实现文档 |
| 版本号 | 2.0 |
| 创建日期 | 2026-01-07 |
| 作者 | 技术架构师 |
| 项目名称 | 大数据商城后端系统 |

## 目录

1. [概述](#概述)
2. [接口设计](#接口设计)
3. [数据模型设计](#数据模型设计)
4. [存储架构设计](#存储架构设计)
5. [缓存策略](#缓存策略)
6. [实现方案](#实现方案)
7. [错误处理](#错误处理)
8. [测试方案](#测试方案)
9. [部署配置](#部署配置)

## 概述

### 项目背景

本接口是大数据库商城后端系统商品管理模块的核心查询功能，主要用于商品详情查看。该接口基于HBase和Redis的大数据技术栈，实现简单的商品数据查询服务。作为学习项目，重点在于掌握大数据技术栈的基本使用，设计上追求简单实用。

### 设计目标

1. **基础查询功能**：实现商品详情查询
2. **缓存优化**：通过Redis缓存提升查询性能
3. **简单实现**：避免复杂的分页和筛选逻辑
4. **学习导向**：专注于大数据技术栈的使用学习

### 技术栈

- **后端框架**：Spring Boot 4.0.1
- **大数据存储**：HBase 2.4.17
- **缓存系统**：Redis 6.x
- **数据序列化**：Jackson
- **连接客户端**：HBase Java API, Jedis
- **Java版本**：Java 17

## 接口设计

### 接口规范

#### 1. 获取商品列表接口

**接口路径**：`GET /api/product/list`

**接口说明**：分页查询商品列表，支持条件筛选和排序

**请求参数**：

| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| page | integer | 否 | 1 | 页码，从1开始 |
| size | integer | 否 | 20 | 每页大小，最大100 |
| category | string | 否 |  | 商品分类ID |
| brand | string | 否 |  | 品牌名称 |
| status | string | 否 | ACTIVE | 商品状态 |
| sortBy | string | 否 | create_time | 排序字段 |
| sortOrder | string | 否 | desc | 排序方向(asc/desc) |

**响应格式**：
```json
{
  "code": 200,
  "message": "查询成功",
  "timestamp": "2026-01-07T10:30:00Z",
  "data": {
    "total": 4,
    "page": 1,
    "size": 20,
    "totalPages": 1,
    "hasNext": false,
    "hasPrevious": false,
    "products": [
      {
        "id": "000100000001",
        "name": "美的空调",
        "category": "0001",
        "brand": "美的",
        "price": 2999.00,
        "status": "ACTIVE",
        "createTime": "2024-01-07T12:30:00"
      },
      {
        "id": "000100000002",
        "name": "华为Mate60 Pro",
        "category": "0001",
        "brand": "华为",
        "price": 6999.00,
        "status": "ACTIVE",
        "createTime": "2024-01-07T12:30:01"
      }
    ]
  }
}
```

#### 2. 查看商品详情接口

**接口路径**：`GET /api/product/{productId}`

**接口说明**：根据商品ID查询完整的商品详细信息

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| productId | string | 是 | 商品ID（12位字符） |

**响应格式**：
```json
{
  "code": 200,
  "message": "查询成功",
  "timestamp": "2026-01-07T10:30:00Z",
  "data": {
    "id": "00010001",
    "name": "华为Mate60 Pro",
    "category": "0001",
    "brand": "华为",
    "price": 6999.00,
    "cost": 5500.00,
    "description": "华为旗舰智能手机，HarmonyOS 4.0",
    "spec": {
      "screen": "6.82英寸",
      "processor": "麒麟9000S",
      "memory": "12GB+512GB",
      "camera": "5000万像素"
    },
    "tags": ["旗舰机", "鸿蒙系统", "5G"],
    "status": "ACTIVE",
    "createTime": "2026-01-07T10:30:00Z",
    "updateTime": "2026-01-07T10:30:00Z",
    "image": {
      "id": "hdfs://bigdata01:9000/product_images/0001/00010001/1704625800000_main.jpg",
      "type": "main",
      "filename": "huawei_mate60_main.jpg",
      "size": 245760,
      "uploadTime": "2026-01-07T10:30:00Z"
    },
    "stock": {
      "total": 1000,
      "safe": 100,
      "lock": 0,
      "warehouse": "BJ001"
    },
    "statistics": {
      "viewCount": 0,
      "saleCount": 0,
      "collectCount": 0
    }
  }
}
```

## 数据模型设计

### 查询响应DTO

#### ProductDetailResponse
```java
public class ProductDetailResponse {
    private String id;
    private String name;
    private String category;
    private String brand;
    private BigDecimal price;
    private BigDecimal cost;
    private String description;
    private Map<String, Object> spec;
    private List<String> tags;
    private String status;
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
    private ProductImage image;
    private ProductStock stock;
    private ProductStatistics statistics;

    // Getters and Setters
}
```

## 存储架构设计

### HBase表结构

#### 商品信息表 (product_info)

**RowKey设计**：{category_id}_{product_id}_{timestamp}
- category_id：分类ID（4位）
- product_id：商品ID（8位）
- timestamp：时间戳（13位）

**列族结构**：
```
product_info
├── cf_base (商品基本信息)
│   ├── name: 商品名称
│   ├── category: 品类编号
│   ├── brand: 品牌
│   ├── price: 价格
│   ├── cost: 成本价
│   ├── status: 状态
│   └── create_time: 创建时间
├── cf_detail (商品详细信息)
│   ├── description: 描述
│   ├── spec: 规格参数
│   ├── image: 图片信息JSON对象（包含HDFS路径、类型、大小等元数据）
│   └── tags: 标签
├── cf_stock (库存信息)
│   ├── total_stock: 总库存
│   ├── warehouse_stock: 仓库库存
│   ├── safe_stock: 安全库存
│   └── lock_stock: 锁定库存
└── cf_stat (统计信息)
    ├── view_count: 浏览数
    ├── sale_count: 销量
    ├── collect_count: 收藏数
    └── update_time: 更新时间
```

### HBase查询设计

#### 1. 商品列表查询
- **Scan操作**：使用Scan扫描获取商品列表
- **过滤器应用**：使用PrefixFilter（分类筛选）和SingleColumnValueFilter（品牌/状态筛选）
- **分页实现**：使用PageFilter限制返回数量
- **排序实现**：通过RowKey自然排序或反转扫描实现升序/降序

#### 2. 商品详情查询
- **Get操作**：根据RowKey精确查询商品详情
- **多列族查询**：一次性获取所有相关信息

## 缓存策略

### Redis缓存设计

#### 商品列表缓存
```redis
# 商品列表缓存 (String) - 暂未实现完整缓存
product:list:{category}:{brand}:{status}:{page}:{size}:{sortBy}:{sortOrder} → JSON字符串
# 过期时间: 300秒(5分钟)
```

#### 商品详情缓存
```redis
# 商品详情缓存 (Hash)
product:cache:{productId} → {
  name: 商品名称,
  category: 品类编号,
  brand: 品牌,
  price: 价格
  # ... 其他字段
}
# 过期时间: 300秒(5分钟)
```

#### 缓存策略
- **读取策略**：Cache Aside模式，先读缓存，缓存未命中再读数据库
- **更新策略**：商品创建时写入缓存，自动过期
- **列表缓存**：仅缓存前3页数据，避免缓存过多
- **简单实现**：不涉及复杂的缓存清理和同步逻辑

## 实现方案

### 核心服务类设计

#### ProductService.getProductList() 方法
```java
@Service
public class ProductService {

    @Autowired
    private ProductHBaseService productHBaseService;

    @Autowired
    private RedisService redisService;

    /**
     * 查询商品列表（带缓存和分页）
     */
    public ProductListResponse getProductList(ProductListQueryRequest request) {
        // 1. 构建缓存Key
        String cacheKey = buildListCacheKey(request);

        // 2. 尝试从缓存获取
        ProductListResponse cached = getProductListFromCache(cacheKey);
        if (cached != null) {
            return cached;
        }

        // 3. 从HBase查询
        ProductListResponse response = productHBaseService.getProductList(request);

        // 4. 回填缓存（只缓存前几页）
        if (request.getPage() <= 3) {
            cacheProductList(cacheKey, response);
        }

        return response;
    }
}
```

#### ProductService.getProduct() 方法
```java
@Service
public class ProductService {

    @Autowired
    private ProductHBaseService productHBaseService;

    @Autowired
    private RedisService redisService;

    /**
     * 查询商品详情（带缓存）
     */
    public Product getProduct(String productId) {
        if (productId == null) {
            return null;
        }

        try {
            // 1. 首先尝试从缓存获取
            Product product = getProductFromCache(productId);
            if (product != null) {
                logger.debug("Retrieved product from cache: {}", productId);
                return product;
            }

            // 2. 从HBase获取
            product = productHBaseService.getProduct(productId);
            if (product != null) {
                // 3. 回填缓存
                redisService.cacheProduct(product);
                if (product.getStock() != null) {
                    redisService.setStock(productId, product.getStock().getTotal());
                }
                logger.debug("Retrieved product from HBase and cached: {}", productId);
            }

            return product;
        } catch (Exception e) {
            logger.error("Failed to get product: {}", productId, e);
            return null;
        }
    }

    /**
     * 从缓存获取商品（私有方法）
     */
    private Product getProductFromCache(String productId) {
        try {
            var cachedData = redisService.getCachedProduct(productId);
            if (cachedData == null || cachedData.isEmpty()) {
                return null;
            }

            // 检查必要字段并构建Product对象
            String name = cachedData.get("name");
            if (name == null || name.trim().isEmpty()) {
                return null;
            }

            Product product = new Product();
            product.setId(productId);
            product.setName(name);
            product.setCategory(cachedData.get("category"));
            product.setBrand(cachedData.get("brand"));

            // 解析价格和状态
            String priceStr = cachedData.get("price");
            if (priceStr != null && !priceStr.trim().isEmpty()) {
                product.setPrice(new BigDecimal(priceStr));
            }

            String statusStr = cachedData.get("status");
            if (statusStr != null && !statusStr.trim().isEmpty()) {
                product.setStatus(ProductStatus.fromCode(statusStr));
            }

            // 获取库存信息
            Integer stock = redisService.getStock(productId);
            if (stock != null) {
                ProductStock productStock = new ProductStock();
                productStock.setTotal(stock);
                product.setStock(productStock);
            }

            return product;
        } catch (Exception e) {
            logger.warn("Failed to get product from cache: {}", productId, e);
            return null;
        }
    }
}
```

### 控制器实现

#### ProductController
```java
@RestController
@RequestMapping("/api/product")
@Profile("dev")
@Api(tags = "商品管理接口")
public class ProductController {

    @Autowired
    private ProductService productService;

    /**
     * 查看商品详情
     */
    @GetMapping("/{productId}")
    @ApiOperation(value = "获取商品信息", notes = "根据商品ID获取商品详细信息")
    public ResponseEntity<ApiResponse<Product>> getProduct(
            @ApiParam(value = "商品ID", required = true, example = "00010001")
            @PathVariable String productId) {

        try {
            Product product = productService.getProduct(productId);

            if (product != null) {
                return ResponseEntity.ok(ApiResponse.success(product, "商品查询成功"));
            } else {
                return ResponseEntity.status(HttpStatus.NOT_FOUND)
                        .body(ApiResponse.error(404, "商品不存在"));
            }

        } catch (Exception e) {
            logger.error("Failed to get product: {}", productId, e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(ApiResponse.error(500, "商品查询失败: " + e.getMessage()));
        }
    }
}
```

## 错误处理

### 异常类型

#### 查询异常
- **参数错误**：400 Bad Request
  - 页码或每页大小超出限制
  - 商品ID格式错误
  - 排序字段不支持

- **商品不存在**：404 Not Found
  - 查询的商品ID不存在

- **系统错误**：500 Internal Server Error
  - HBase连接异常
  - Redis连接异常
  - 数据解析异常

### 错误响应格式
```json
{
  "code": 404,
  "message": "商品不存在",
  "timestamp": "2026-01-07T10:30:00Z",
  "data": null
}
```

## 性能优化

### 查询优化策略

#### 1. HBase查询优化
- **列表查询**：使用Scan + 过滤器进行条件查询
- **精确查询**：使用Get操作进行精确查询，避免全表扫描
- **分页优化**：使用PageFilter限制查询结果数量
- **列族设计**：合理设计列族减少数据传输

#### 2. 缓存优化
- **列表缓存**：对常见查询条件的前几页进行缓存
- **详情缓存**：使用Redis缓存商品详情信息
- **过期策略**：设置合理的缓存过期时间（5分钟）

### 性能指标目标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 商品列表查询响应时间 | < 500ms | 平均响应时间 |
| 商品详情查询响应时间 | < 200ms | 平均响应时间 |
| 缓存命中率 | > 60% | Redis缓存命中率 |

## 测试方案

### 单元测试

#### ProductServiceTest
```java
@SpringBootTest
public class ProductServiceTest {

    @Autowired
    private ProductService productService;

    @Test
    public void testGetProduct() {
        // 测试商品详情查询
        String productId = "00010001";
        Product product = productService.getProduct(productId);

        assertNotNull(product);
        assertEquals(productId, product.getId());
        assertNotNull(product.getName());
        assertNotNull(product.getPrice());
    }

    @Test
    public void testGetProductNotFound() {
        // 测试商品不存在的情况
        String productId = "99999999";
        Product product = productService.getProduct(productId);

        assertNull(product);
    }
}
```

### 集成测试

#### API测试用例

1. **商品列表查询测试**
   ```
   GET /api/product/list?page=1&size=10
   预期：返回商品列表，包含分页信息
   ```

2. **商品列表条件筛选测试**
   ```
   GET /api/product/list?category=0001&brand=华为&page=1&size=5
   预期：返回分类为0001、品牌为华为的商品列表
   ```

3. **商品详情查询测试**
   ```
   GET /api/product/000100000001
   预期：返回完整的商品详细信息
   ```

4. **商品不存在测试**
   ```
   GET /api/product/999999999999
   预期：返回404错误，商品不存在
   ```

5. **参数校验测试**
   ```
   GET /api/product/123
   预期：返回400错误，商品ID格式不正确
   ```

6. **缓存测试**
   - 首次查询商品，验证从HBase读取并回填缓存
   - 再次查询同一商品，验证从缓存读取
   - 等待缓存过期后查询，验证重新从HBase读取

## 部署配置

### 环境配置

#### application-dev.properties
```properties
# HBase配置
hbase.zookeeper.quorum=192.168.32.200:2181,192.168.32.201:2181,192.168.32.202:2181
hbase.product.table.name=product_info_dev

# Redis配置
redis.host=192.168.32.200
redis.port=6379
redis.password=123456
redis.database=1
redis.pool.max-total=20
redis.pool.max-idle=10
redis.pool.min-idle=5
```

### 监控配置

#### 性能监控指标
- 查询响应时间
- 缓存命中率
- HBase查询次数
- Redis连接池使用情况

#### 健康检查
```java
@Component
public class ProductQueryHealthIndicator implements HealthIndicator {

    @Override
    public Health health() {
        try {
            // 检查HBase连接
            // 检查Redis连接
            // 执行简单查询测试

            return Health.up().build();
        } catch (Exception e) {
            return Health.down(e).build();
        }
    }
}
```

---

**文档版本**：2.0
**最后更新**：2026-01-07
**作者**：技术架构师
**更新说明**：简化设计，取消分页查询，与实际项目实现保持一致

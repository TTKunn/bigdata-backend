# [002] 大数据商城后端系统 API 接口文档

## 文档信息

| 文档编号 | [002] |
|----------|-------|
| 文档名称 | 大数据商城后端系统 API 接口文档 |
| 版本号 | 1.0 |
| 创建日期 | 2026-01-07 |
| 作者 | API 接口文档编写者 |
| 项目名称 | 大数据商城后端系统 |
| 最后更新 | 2026-01-07 |

## 目录

1. [概述](#概述)
2. [通用规范](#通用规范)
3. [商品管理接口](#商品管理接口)
   - [3.1 创建商品](#31-创建商品)
   - [3.2 获取商品信息](#32-获取商品信息)
   - [3.3 更新商品库存](#33-更新商品库存)
   - [3.4 服务健康检查](#34-服务健康检查)
4. [错误码说明](#错误码说明)
5. [测试用例](#测试用例)

## 概述

### 接口说明

本文档描述了大数据商城后端系统提供的REST API接口，主要包含商品管理的相关功能。所有接口都遵循RESTful设计规范，使用JSON格式进行数据传输。

### 技术栈

- **框架**：Spring Boot 3.x
- **数据格式**：JSON
- **认证方式**：API Key (开发环境)
- **文档工具**：Swagger 2.0
- **测试工具**：ApiFox/Postman

### 环境信息

- **开发环境**：http://localhost:8080
- **API前缀**：`/api` (商品管理接口)
- **Swagger文档**：http://localhost:8080/swagger-ui.html (仅开发环境)

### 注意事项

1. 所有接口直接可用，无需特殊环境配置
2. 请求和响应数据格式均为JSON
3. 时间格式统一为ISO 8601标准：`yyyy-MM-dd'T'HH:mm:ss'Z'`
4. 所有金额字段单位为人民币元，支持小数点后2位

## 通用规范

### 请求头规范

| Header | 值 | 必填 | 说明 |
|--------|----|------|------|
| Content-Type | application/json | 是 | 请求体数据格式 |

### 响应格式

#### 成功响应
```json
{
  "code": 200,
  "message": "操作成功",
  "timestamp": "2026-01-07T10:30:00Z",
  "data": {
    // 具体数据内容
  }
}
```

#### 错误响应
```json
{
  "code": 400,
  "message": "参数校验失败",
  "timestamp": "2026-01-07T10:30:00Z",
  "data": null
}
```

### 字段类型说明

| 类型 | 说明 | 示例 |
|------|------|------|
| string | 字符串 | "商品名称" |
| number | 数字（支持小数） | 99.99 |
| integer | 整数 | 100 |
| boolean | 布尔值 | true |
| object | 对象 | {"key": "value"} |
| array | 数组 | ["item1", "item2"] |

## 商品管理接口

### 3.1 创建商品

#### 接口描述
创建新的商品信息，支持商品基本信息、规格参数、单张照片上传（最大10MB）和库存设置等完整功能。

#### 请求信息
- **接口路径**：`POST /api/product`
- **请求方法**：POST
- **Content-Type**：multipart/form-data（推荐，支持文件上传）

**注：** 同时支持 `application/json` 和 `multipart/form-data` 两种格式

#### 请求参数

##### 请求头 (Headers)
无特殊请求头要求

##### 请求体 (Body) - JSON格式
```json
{
  "id": "00010001",
  "name": "华为Mate60 Pro",
  "category": "0001",
  "brand": "华为",
  "price": 6999.00,
  "cost": 5500.00,
  "description": "华为旗舰智能手机，HarmonyOS 4.0",
  "spec": {
    "screen": "6.82英寸",
    "processor": "麒麟9000S",
    "memory": "12GB+512GB",
    "camera": "5000万像素"
  },
  "tags": ["旗舰机", "鸿蒙系统", "5G"],
  "image": {
    "file": "base64_encoded_image_data",
    "type": "main",
    "filename": "huawei_mate60_main.jpg"
  },
  "stock": {
    "total": 1000,
    "safe": 100,
    "warehouse": "BJ001"
  }
}
```

##### Form Data格式 (推荐用于ApiFox测试)
使用 `multipart/form-data` 格式，支持直接上传图片文件：

**表单字段：**
- `id`: `00010001` (商品ID)
- `name`: `华为Mate60 Pro` (商品名称)
- `category`: `0001` (分类ID)
- `brand`: `华为` (品牌)
- `price`: `6999.00` (价格)
- `cost`: `5500.00` (成本价)
- `description`: `华为旗舰智能手机，HarmonyOS 4.0` (描述)
- `spec`: `{"screen":"6.82英寸","processor":"麒麟9000S","memory":"12GB+512GB","camera":"5000万像素"}` (规格参数JSON字符串)
- `tags`: `["旗舰机","鸿蒙系统","5G"]` (标签数组JSON字符串)
- `stock`: `{"total":1000,"safe":100,"warehouse":"BJ001"}` (库存信息JSON字符串)

**文件字段：**
- `image`: 选择单张图片文件（最大10MB）
- `imageType`: 图片类型，固定为 `main`（主图）

**Form Data示例：**

在ApiFox中选择"Form Data"标签页，添加以下字段：

| 字段名 | 值 | 说明 |
|--------|-----|------|
| id | `00010001` | 商品ID |
| name | `华为Mate60 Pro` | 商品名称 |
| category | `0001` | 分类ID |
| brand | `华为` | 品牌名称 |
| price | `6999.00` | 商品价格 |
| cost | `5500.00` | 成本价 |
| description | `华为旗舰智能手机，HarmonyOS 4.0` | 商品描述 |
| spec | `{"screen":"6.82英寸","processor":"麒麟9000S","memory":"12GB+512GB","camera":"5000万像素"}` | 规格参数JSON |
| tags | `["旗舰机","鸿蒙系统","5G"]` | 标签数组JSON |
| stock | `{"total":1000,"safe":100,"warehouse":"BJ001"}` | 库存信息JSON |
| image | [选择图片文件] | 点击"选择文件"上传单张图片（最大10MB） |
| imageType | `main` | 图片类型（固定为main，表示主图） |

**图片上传说明：**
- `image`字段：点击文件选择器，选择单张图片文件
- `imageType`字段：固定填写 `main`，表示主图
- 支持的图片格式：jpg、png、gif等常见格式
- 图片大小限制：最大10MB

## ApiFox测试步骤（Form Data方式）

### 1. 创建新请求
- 在ApiFox中点击"新建请求"
- 请求名称：创建商品(Form Data)
- 请求方法：POST
- 请求URL：`http://localhost:8080/api/product`

### 2. 设置请求头
由于使用Form Data，Content-Type会自动设置为`multipart/form-data`，无需手动设置。

### 3. 配置Form Data参数
在"请求体"标签页中选择"Form Data"，然后添加以下字段：

**文本字段：**
```
id = 00010001
name = 华为Mate60 Pro
category = 0001
brand = 华为
price = 6999.00
cost = 5500.00
description = 华为旗舰智能手机，HarmonyOS 4.0
spec = {"screen":"6.82英寸","processor":"麒麟9000S","memory":"12GB+512GB","camera":"5000万像素"}
tags = ["旗舰机","鸿蒙系统","5G"]
stock = {"total":1000,"safe":100,"warehouse":"BJ001"}
imageType = main
```

**文件字段：**
- `image`：点击"选择文件"，选择单张图片文件（如华为手机图片，最大10MB）

### 4. 发送请求
- 点击"发送"按钮
- 查看响应结果

### 5. 验证结果
成功响应应该包含：
- 上传的单张图片信息（HDFS路径、文件大小等）
- 商品创建成功消息
- 商品ID确认

### 注意事项
1. 确保Spring Boot应用正在运行
2. 如果图片上传失败，检查图片文件格式和大小（最大10MB）
3. JSON字符串格式必须正确（使用双引号，不要有语法错误）
4. 每个商品仅支持上传单张主图

##### 参数字段说明

**JSON格式参数：**

| 参数名 | 类型 | 必填 | 说明 | 约束 |
|--------|------|------|------|------|
| id | string | 是 | 商品ID，全局唯一 | 12位字符，格式：{category_id(4位)}{product_id(8位)} |
| name | string | 是 | 商品名称 | 最大200字符 |
| category | string | 是 | 商品分类ID | 4位字符 |
| brand | string | 否 | 品牌名称 | 最大100字符 |
| price | number | 是 | 销售价格 | 大于0，小数点后最多2位 |
| cost | number | 否 | 成本价 | 大于等于0，小数点后最多2位 |
| description | string | 否 | 商品描述 | 最大2000字符 |
| spec | object | 否 | 商品规格参数 | JSON对象，键值对形式 |
| tags | array | 否 | 商品标签 | 字符串数组 |
| image | object | 否 | 商品主图 | 单张图片对象，最大10MB |
| stock | object | 否 | 库存信息 | 库存对象 |

**Form Data格式参数：**

| 字段名 | 类型 | 必填 | 说明 | 格式示例 |
|--------|------|------|------|----------|
| id | text | 是 | 商品ID | `00010001` |
| name | text | 是 | 商品名称 | `华为Mate60 Pro` |
| category | text | 是 | 商品分类ID | `0001` |
| brand | text | 否 | 品牌名称 | `华为` |
| price | text | 是 | 销售价格 | `6999.00` |
| cost | text | 否 | 成本价 | `5500.00` |
| description | text | 否 | 商品描述 | `华为旗舰智能手机，HarmonyOS 4.0` |
| spec | text | 否 | 商品规格参数 | `{"screen":"6.82英寸","processor":"麒麟9000S"}` |
| tags | text | 否 | 商品标签 | `["旗舰机","鸿蒙系统","5G"]` |
| stock | text | 否 | 库存信息 | `{"total":1000,"safe":100,"warehouse":"BJ001"}` |
| image | file | 否 | 图片文件 | 选择单张图片文件（最大10MB） |
| imageType | text | 否 | 图片类型 | `main`（固定为main，表示主图） |

##### image对象结构
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| file | string | 是 | 图片文件数据（Base64编码或文件URL） |
| type | string | 是 | 图片类型：main(主图) |
| filename | string | 是 | 原始文件名 |

##### stock对象结构
| 参数名 | 类型 | 必填 | 说明 | 约束 |
|--------|------|------|------|------|
| total | integer | 否 | 总库存数量 | 大于等于0，默认0 |
| safe | integer | 否 | 安全库存数量 | 大于等于0，默认0 |
| warehouse | string | 是 | 仓库编码 | 非空字符串 |

#### 响应信息

##### 成功响应 (200)
```json
{
  "code": 200,
  "message": "商品创建成功",
  "timestamp": "2026-01-07T10:30:00Z",
  "data": {
    "productId": "00010001",
    "createTime": "2026-01-07T10:30:00Z",
    "image": {
      "id": "hdfs://bigdata01:9000/product_images/0001/00010001/1704625800000_main.jpg",
      "type": "main",
      "filename": "huawei_mate60_main.jpg",
      "size": 245760,
      "uploadTime": "2026-01-07T10:30:00Z"
    }
  }
}
```

##### 响应字段说明
| 字段名 | 类型 | 说明 |
|--------|------|------|
| productId | string | 创建成功的商品ID |
| createTime | string | 商品创建时间 |
| image | object | 上传成功的单张图片信息对象 |

#### 错误响应

##### 参数校验失败 (400)
```json
{
  "code": 400,
  "message": "商品ID格式不正确，应为12位字符",
  "timestamp": "2026-01-07T10:30:00Z",
  "data": null
}
```


##### 商品已存在 (409)
```json
{
  "code": 409,
  "message": "商品ID已存在",
  "timestamp": "2026-01-07T10:30:00Z",
  "data": null
}
```

##### 系统错误 (500)
```json
{
  "code": 500,
  "message": "商品创建失败: HBase存储异常",
  "timestamp": "2026-01-07T10:30:00Z",
  "data": null
}
```

### 3.2 获取商品列表

#### 接口描述
分页查询商品列表，支持按分类、品牌、状态等条件筛选，并支持排序功能。

#### 请求信息
- **接口路径**：`GET /api/product/list`
- **请求方法**：GET

#### 请求参数

##### 查询参数 (Query Parameters)
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| page | integer | 否 | 1 | 页码，从1开始 |
| size | integer | 否 | 20 | 每页大小，最大100 |
| category | string | 否 |  | 商品分类ID |
| brand | string | 否 |  | 品牌名称 |
| status | string | 否 | ACTIVE | 商品状态 |
| sortBy | string | 否 | create_time | 排序字段 |
| sortOrder | string | 否 | desc | 排序方向(asc/desc) |

##### 请求头 (Headers)
无特殊请求头要求

#### 响应信息

##### 成功响应 (200)
```json
{
  "code": 200,
  "message": "查询成功",
  "timestamp": "2026-01-07T10:30:00Z",
  "data": {
    "total": 4,
    "page": 1,
    "size": 20,
    "totalPages": 1,
    "hasNext": false,
    "hasPrevious": false,
    "products": [
      {
        "id": "000100000001",
        "name": "美的空调",
        "category": "0001",
        "brand": "美的",
        "price": 2999.00,
        "status": "ACTIVE",
        "createTime": "2024-01-07T12:30:00"
      },
      {
        "id": "000100000002",
        "name": "华为Mate60 Pro",
        "category": "0001",
        "brand": "华为",
        "price": 6999.00,
        "status": "ACTIVE",
        "createTime": "2024-01-07T12:30:01"
      }
    ]
  }
}
```

##### 错误响应

###### 参数错误 (400)
```json
{
  "code": 400,
  "message": "Invalid request parameters for product list",
  "timestamp": "2026-01-07T10:30:00Z",
  "data": null
}
```

###### 系统错误 (500)
```json
{
  "code": 500,
  "message": "查询失败: HBase连接异常",
  "timestamp": "2026-01-07T10:30:00Z",
  "data": null
}
```

### 3.4 获取商品信息

#### 接口描述
根据商品ID获取商品的详细信息，包括基本信息、规格参数、图片和库存等。

#### 请求信息
- **接口路径**：`GET /api/product/{productId}`
- **请求方法**：GET

#### 请求参数

##### 路径参数 (Path Parameters)
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| productId | string | 是 | 商品ID |

##### 请求头 (Headers)
无特殊请求头要求

#### 响应信息

##### 成功响应 (200)
```json
{
  "code": 200,
  "message": "商品查询成功",
  "timestamp": "2026-01-07T10:30:00Z",
  "data": {
    "id": "00010001",
    "name": "华为Mate60 Pro",
    "category": "0001",
    "brand": "华为",
    "price": 6999.00,
    "cost": 5500.00,
    "description": "华为旗舰智能手机，HarmonyOS 4.0",
    "spec": {
      "screen": "6.82英寸",
      "processor": "麒麟9000S",
      "memory": "12GB+512GB",
      "camera": "5000万像素"
    },
    "tags": ["旗舰机", "鸿蒙系统", "5G"],
    "image": {
      "id": "hdfs://bigdata01:9000/product_images/0001/00010001/1704625800000_main.jpg",
      "type": "main",
      "filename": "huawei_mate60_main.jpg",
      "size": 245760,
      "uploadTime": "2026-01-07T10:30:00Z"
    },
    "stock": {
      "total": 1000,
      "safe": 100,
      "lock": 0,
      "warehouse": "BJ001"
    },
    "status": "ACTIVE",
    "createTime": "2026-01-07T10:30:00Z",
    "updateTime": "2026-01-07T10:30:00Z"
  }
}
```

##### 商品不存在 (404)
```json
{
  "code": 404,
  "message": "商品不存在",
  "timestamp": "2026-01-07T10:30:00Z",
  "data": null
}
```

### 3.5 更新商品库存

#### 接口描述
扣减指定商品的库存数量，用于模拟订单扣减库存的操作。

#### 请求信息
- **接口路径**：`PUT /api/product/{productId}/stock`
- **请求方法**：PUT

#### 请求参数

##### 路径参数
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| productId | string | 是 | 商品ID |

##### 查询参数
| 参数名 | 类型 | 必填 | 说明 | 默认值 |
|--------|------|------|------|--------|
| quantity | integer | 是 | 扣减数量 | 无 |

##### 请求头
无特殊请求头要求

#### 响应信息

##### 成功响应 (200)
```json
{
  "code": 200,
  "message": "库存更新成功",
  "timestamp": "2026-01-07T10:30:00Z",
  "data": null
}
```

##### 库存不足 (409)
```json
{
  "code": 409,
  "message": "库存不足",
  "timestamp": "2026-01-07T10:30:00Z",
  "data": null
}
```

### 3.6 服务健康检查

#### 接口描述
检查商品服务及相关组件（HBase、Redis、HDFS）的健康状态。

#### 请求信息
- **接口路径**：`GET /api/product/health`
- **请求方法**：GET

#### 响应信息

##### 服务正常 (200)
```json
{
  "code": 200,
  "message": "服务运行正常",
  "timestamp": "2026-01-07T10:30:00Z",
  "data": null
}
```

##### 服务异常 (503)
```json
{
  "code": 503,
  "message": "服务不可用",
  "timestamp": "2026-01-07T10:30:00Z",
  "data": null
}
```

## 错误码说明

| 错误码 | HTTP状态码 | 说明 | 可能原因 |
|--------|------------|------|----------|
| 400 | 400 | 参数校验失败 | 请求参数格式错误、必填参数缺失 |
| 404 | 404 | 资源不存在 | 商品ID不存在 |
| 409 | 409 | 资源冲突 | 商品ID已存在、库存不足 |
| 500 | 500 | 服务器内部错误 | 数据库连接失败、文件上传失败等 |

## 测试用例

### 测试环境准备

1. 启动大数据集群（Hadoop、HBase、Redis）
2. 启动Spring Boot应用（开发环境）
3. 准备测试数据和图片文件

### 创建商品测试用例

#### 用例1：正常创建商品
**请求：**
```bash
POST http://localhost:8080/api/product
Body: 见接口文档示例
```

**预期结果：** HTTP 200，商品创建成功

#### 用例2：商品ID已存在
**请求：** 使用已存在的商品ID重复创建

**预期结果：** HTTP 409，提示商品已存在

#### 用例3：参数校验失败
**请求：** 缺少必填参数或参数格式错误

**预期结果：** HTTP 400，提示具体错误信息


### 查询商品测试用例

#### 用例1：查询存在的商品
**请求：**
```bash
GET http://localhost:8080/api/product/000100000001
```

**预期结果：** HTTP 200，返回商品详细信息

#### 用例2：查询不存在的商品
**请求：** 使用不存在的商品ID

**预期结果：** HTTP 404，提示商品不存在

### 库存更新测试用例

#### 用例1：正常扣减库存
**请求：**
```bash
PUT http://localhost:8080/api/product/000100000001/stock?quantity=1
```

**预期结果：** HTTP 200，库存扣减成功

#### 用例2：库存不足
**请求：** 扣减数量超过现有库存

**预期结果：** HTTP 409，提示库存不足

## 注意事项

1. **接口可用性**：所有接口直接可用，无需profile配置
2. **数据一致性**：系统采用缓存优先策略，确保Redis和HBase数据最终一致性
3. **图片上传**：支持Base64编码和文件URL两种方式
4. **事务处理**：商品创建涉及多组件操作，失败时会自动回滚
5. **性能考虑**：接口包含参数校验、数据转换和多组件协调，开销相对较大

---

**文档状态**：完成
**审核状态**：待审核
**版本控制**：
- v1.0 (2026-01-07)：初始版本，完成商品管理API接口文档
